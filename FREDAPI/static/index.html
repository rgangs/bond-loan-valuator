<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yield Curve Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .chart {
            height: 400px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls label {
            font-weight: 600;
            color: #333;
        }

        .controls input, .controls select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .controls button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background 0.3s;
        }

        .controls button:hover {
            background: #5568d3;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            padding: 20px;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .info-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .info-panel h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .info-panel p {
            color: #666;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“ˆ Treasury & Corporate Bond Yield Curves</h1>
            <p class="subtitle">Interactive Bootstrapped Curves Dashboard</p>
        </header>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="treasuryCurves">-</div>
                <div class="stat-label">Treasury Curves</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="corporateCurves">-</div>
                <div class="stat-label">Corporate Curves</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="latestDate">-</div>
                <div class="stat-label">Latest Date</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="dataPoints">-</div>
                <div class="stat-label">Total Data Points</div>
            </div>
        </div>

        <div class="controls">
            <label for="curveDate">Select Date:</label>
            <input type="date" id="curveDate">
            <button onclick="loadCurves()">Load Curves</button>
            <button onclick="loadLatestCurves()">Load Latest</button>
        </div>

        <div id="errorMessage"></div>
        <div id="loading" class="loading" style="display:none;">Loading curves...</div>

        <div class="dashboard">
            <div class="card">
                <h2>US Treasury Yield Curve</h2>
                <div id="treasuryChart" class="chart"></div>
            </div>
            <div class="card">
                <h2>Corporate Bond Yield Curve</h2>
                <div id="corporateChart" class="chart"></div>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2>Treasury Forward Rates</h2>
                <div id="forwardRatesChart" class="chart"></div>
            </div>
            <div class="card">
                <h2>Corporate Spreads Over Treasury</h2>
                <div id="spreadChart" class="chart"></div>
            </div>
        </div>

        <div class="info-panel">
            <h3>About This Dashboard</h3>
            <p>
                This dashboard displays bootstrapped yield curves for US Treasuries and Corporate Bonds.
                Data is sourced from the Federal Reserve Economic Data (FRED) API and processed using
                cubic spline interpolation for smooth daily granularity. Curves are automatically updated
                daily at 6:00 PM.
            </p>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';

        // Initialize with today's date
        document.getElementById('curveDate').valueAsDate = new Date();

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/dates/available`);
                const data = await response.json();

                const treasury = data.find(d => d.curve_type === 'treasury');
                const corporate = data.find(d => d.curve_type === 'corporate');

                if (treasury) {
                    document.getElementById('treasuryCurves').textContent = treasury.total_dates.toLocaleString();
                    document.getElementById('latestDate').textContent = treasury.end_date;
                }

                if (corporate) {
                    document.getElementById('corporateCurves').textContent = corporate.total_dates.toLocaleString();
                }

                // Estimate total data points
                const totalPoints = (treasury?.total_dates || 0) * 11 + (corporate?.total_dates || 0) * 10;
                document.getElementById('dataPoints').textContent = totalPoints.toLocaleString();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadLatestCurves() {
            showLoading(true);
            hideError();

            try {
                const [treasuryResponse, corporateResponse] = await Promise.all([
                    fetch(`${API_BASE}/treasury/latest?max_points=300`),
                    fetch(`${API_BASE}/corporate/latest?max_points=300`)
                ]);

                if (!treasuryResponse.ok && !corporateResponse.ok) {
                    throw new Error('No curve data available');
                }

                let treasuryData = null;
                let corporateData = null;

                if (treasuryResponse.ok) {
                    treasuryData = await treasuryResponse.json();
                    plotTreasuryCurve(treasuryData);
                    plotForwardRates(treasuryData);
                }

                if (corporateResponse.ok) {
                    corporateData = await corporateResponse.json();
                    plotCorporateCurve(corporateData);
                }

                if (treasuryData && corporateData) {
                    plotSpreads(treasuryData, corporateData);
                }

                showLoading(false);
            } catch (error) {
                showError('Error loading latest curves: ' + error.message);
                showLoading(false);
            }
        }

        async function loadCurves() {
            const dateInput = document.getElementById('curveDate');
            const selectedDate = dateInput.value;

            if (!selectedDate) {
                showError('Please select a date');
                return;
            }

            showLoading(true);
            hideError();

            try {
                const [treasuryResponse, corporateResponse] = await Promise.all([
                    fetch(`${API_BASE}/treasury/${selectedDate}?max_points=300`),
                    fetch(`${API_BASE}/corporate/${selectedDate}?max_points=300`)
                ]);

                let treasuryData = null;
                let corporateData = null;

                if (treasuryResponse.ok) {
                    treasuryData = await treasuryResponse.json();
                    plotTreasuryCurve(treasuryData);
                    plotForwardRates(treasuryData);
                } else {
                    plotTreasuryCurve(null);
                    plotForwardRates(null);
                }

                if (corporateResponse.ok) {
                    corporateData = await corporateResponse.json();
                    plotCorporateCurve(corporateData);
                } else {
                    plotCorporateCurve(null);
                }

                if (treasuryData && corporateData) {
                    plotSpreads(treasuryData, corporateData);
                } else {
                    plotSpreads(null, null);
                }

                showLoading(false);
            } catch (error) {
                showError('Error loading curves: ' + error.message);
                showLoading(false);
            }
        }

        function plotTreasuryCurve(data) {
            const element = document.getElementById('treasuryChart');

            if (!data) {
                Plotly.newPlot(element, [], {
                    title: 'No data available for this date',
                    xaxis: { title: 'Maturity (Years)' },
                    yaxis: { title: 'Yield (%)' }
                });
                return;
            }

            const traces = [];

            // Plot smooth interpolated curve (daily granularity)
            if (data.maturities && data.yields) {
                traces.push({
                    x: data.maturities,
                    y: data.yields,
                    mode: 'lines',
                    name: 'Bootstrapped Curve',
                    line: { color: '#667eea', width: 2 },
                    hovertemplate: 'Maturity: %{x:.4f}Y<br>Yield: %{y:.3f}%<extra></extra>'
                });
            }

            // Plot original market data points as markers
            if (data.original_maturities && data.original_yields) {
                traces.push({
                    x: data.original_maturities,
                    y: data.original_yields,
                    mode: 'markers',
                    name: 'Market Data',
                    marker: {
                        size: 10,
                        color: '#ff6b6b',
                        symbol: 'diamond',
                        line: { width: 2, color: 'white' }
                    },
                    hovertemplate: 'Maturity: %{x}Y<br>Yield: %{y:.3f}%<extra></extra>'
                });
            }

            const layout = {
                title: `Treasury Yield Curve - ${data.curve_date} (${data.maturities?.length || 0} interpolated points)`,
                xaxis: {
                    title: 'Maturity (Years)',
                    gridcolor: '#e0e0e0'
                },
                yaxis: {
                    title: 'Yield (%)',
                    gridcolor: '#e0e0e0'
                },
                hovermode: 'closest',
                plot_bgcolor: '#fafafa',
                showlegend: true,
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(255,255,255,0.8)',
                    bordercolor: '#ddd',
                    borderwidth: 1
                }
            };

            Plotly.newPlot(element, traces, layout, {responsive: true});
        }

        function plotCorporateCurve(data) {
            const element = document.getElementById('corporateChart');

            if (!data) {
                Plotly.newPlot(element, [], {
                    title: 'No data available for this date',
                    xaxis: { title: 'Maturity (Years)' },
                    yaxis: { title: 'Yield (%)' }
                });
                return;
            }

            const traces = [];

            // Plot smooth interpolated curve (daily granularity)
            if (data.maturities && data.yields) {
                traces.push({
                    x: data.maturities,
                    y: data.yields,
                    mode: 'lines',
                    name: 'Bootstrapped Curve',
                    line: { color: '#f093fb', width: 2 },
                    hovertemplate: 'Maturity: %{x:.4f}Y<br>Yield: %{y:.3f}%<extra></extra>'
                });
            }

            // Plot original market data points as markers
            if (data.original_maturities && data.original_yields) {
                traces.push({
                    x: data.original_maturities,
                    y: data.original_yields,
                    mode: 'markers',
                    name: 'Market Data',
                    marker: {
                        size: 10,
                        color: '#ff6b6b',
                        symbol: 'diamond',
                        line: { width: 2, color: 'white' }
                    },
                    hovertemplate: 'Maturity: %{x}Y<br>Yield: %{y:.3f}%<extra></extra>'
                });
            }

            const layout = {
                title: `Corporate Bond Yield Curve - ${data.curve_date} (${data.maturities?.length || 0} interpolated points)`,
                xaxis: {
                    title: 'Maturity (Years)',
                    gridcolor: '#e0e0e0'
                },
                yaxis: {
                    title: 'Yield (%)',
                    gridcolor: '#e0e0e0'
                },
                hovermode: 'closest',
                plot_bgcolor: '#fafafa',
                showlegend: true,
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(255,255,255,0.8)',
                    bordercolor: '#ddd',
                    borderwidth: 1
                }
            };

            Plotly.newPlot(element, traces, layout, {responsive: true});
        }

        function plotForwardRates(data) {
            const element = document.getElementById('forwardRatesChart');

            if (!data || !data.forward_rates) {
                Plotly.newPlot(element, [], {
                    title: 'No data available',
                    xaxis: { title: 'Maturity (Years)' },
                    yaxis: { title: 'Forward Rate (%)' }
                });
                return;
            }

            const trace = {
                x: data.maturities,
                y: data.forward_rates,
                mode: 'lines+markers',
                name: 'Forward Rates',
                line: { color: '#4facfe', width: 3 },
                marker: { size: 8, color: '#4facfe' }
            };

            const layout = {
                title: `Forward Rates - ${data.curve_date}`,
                xaxis: {
                    title: 'Maturity (Years)',
                    gridcolor: '#e0e0e0'
                },
                yaxis: {
                    title: 'Forward Rate (%)',
                    gridcolor: '#e0e0e0'
                },
                hovermode: 'closest',
                plot_bgcolor: '#fafafa'
            };

            Plotly.newPlot(element, [trace], layout, {responsive: true});
        }

        function plotSpreads(treasuryData, corporateData) {
            const element = document.getElementById('spreadChart');

            if (!treasuryData || !corporateData) {
                Plotly.newPlot(element, [], {
                    title: 'No data available',
                    xaxis: { title: 'Maturity (Years)' },
                    yaxis: { title: 'Spread (bps)' }
                });
                return;
            }

            // Calculate spreads for matching maturities
            const spreads = [];
            const maturities = [];

            corporateData.maturities.forEach((mat, idx) => {
                const treasuryIdx = treasuryData.maturities.findIndex(m => Math.abs(m - mat) < 0.01);
                if (treasuryIdx !== -1) {
                    maturities.push(mat);
                    const spreadBps = (corporateData.yields[idx] - treasuryData.yields[treasuryIdx]) * 100;
                    spreads.push(spreadBps);
                }
            });

            const trace = {
                x: maturities,
                y: spreads,
                mode: 'lines+markers',
                name: 'Credit Spread',
                line: { color: '#fa709a', width: 3 },
                marker: { size: 8, color: '#fa709a' }
            };

            const layout = {
                title: `Corporate Spreads Over Treasury - ${corporateData.curve_date}`,
                xaxis: {
                    title: 'Maturity (Years)',
                    gridcolor: '#e0e0e0'
                },
                yaxis: {
                    title: 'Spread (basis points)',
                    gridcolor: '#e0e0e0'
                },
                hovermode: 'closest',
                plot_bgcolor: '#fafafa'
            };

            Plotly.newPlot(element, [trace], layout, {responsive: true});
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error">${message}</div>`;
        }

        function hideError() {
            document.getElementById('errorMessage').innerHTML = '';
        }

        // Load stats and latest curves on page load
        window.addEventListener('load', () => {
            loadStats();
            loadLatestCurves();
        });
    </script>
</body>
</html>
